<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏û‡∏≤‡∏£‡πå‡∏Å‡∏¥‡∏ô‡∏™‡∏±‡∏ô</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f7f6; color: #333; }
        .app-header { background: linear-gradient(135deg, #4CAF50, #2E7D32); color: white; padding: 20px; text-align: center; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .card { border: none; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-header { background-color: white; border-bottom: 2px solid #f0f0f0; font-weight: bold; font-size: 1.2rem; border-top-left-radius: 15px; border-top-right-radius: 15px; }
        .form-label { font-weight: 500; color: #555; }
        .form-control { border-radius: 10px; padding: 12px; font-size: 1.1rem; }
        .btn-primary { background-color: #4CAF50; border: none; border-radius: 10px; padding: 12px; font-size: 1.2rem; font-weight: bold; }
        .btn-primary:hover { background-color: #388E3C; }
        .drug-card { border: 1px solid #e0e0e0; border-radius: 10px; padding: 10px; margin-bottom: 10px; display: flex; align-items: center; background-color: #fafafa; }
        .drug-img { width: 60px; height: 60px; object-fit: contain; background-color: white; border-radius: 8px; border: 1px solid #ddd; margin-right: 15px; padding: 5px; }
        .loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255,255,255,0.95); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner-border { width: 3rem; height: 3rem; color: #4CAF50; }
        .checkbox-lg .form-check-input { width: 1.5em; height: 1.5em; margin-top: 0.1em; }
        .checkbox-lg .form-check-label { font-size: 1.1rem; margin-left: 0.5em; padding-top: 0.2em; }
    </style>
</head>
<body>

    <div id="loading" class="loading-screen">
        <div class="spinner-border" role="status"></div>
        <h4 class="mt-3 text-success">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</h4>
        <p class="text-muted small">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
    </div>

    <div id="bindScreen" class="container mt-5 d-none">
        <div class="card shadow-sm border-0">
            <div class="card-body p-4 text-center">
                <img src="https://cdn-icons-png.flaticon.com/512/3063/3063822.png" alt="Register" width="80" class="mb-3">
                <h3 class="text-primary fw-bold">‡∏ú‡∏π‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h3>
                <p class="text-muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</p>
                
                <div class="mb-3 text-start mt-4">
                    <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (HN)</label>
                    <input type="text" id="bindHN" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô 123456">
                </div>
                <div class="mb-4 text-start">
                    <label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                    <input type="tel" id="bindPhone" class="form-control" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÑ‡∏ß‡πâ‡∏Å‡∏±‡∏ö‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•">
                </div>
                <button class="btn btn-primary w-100 py-3" onclick="bindAccount()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</button>
            </div>
        </div>
    </div>

    <div id="lockedScreen" class="container mt-5 d-none text-center">
        <img src="https://cdn-icons-png.flaticon.com/512/1055/1055183.png" alt="Lock" width="100" class="mb-3 opacity-50">
        <h3 class="text-danger fw-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</h3>
        <p class="fs-5 mt-3">‡∏ó‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß<br>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</p>
        <div class="alert alert-warning d-inline-block mt-2 fs-5">
            ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà<br>
            <strong id="nextDate" class="fs-4 text-dark"></strong>
        </div>
        <button class="btn btn-secondary w-100 mt-4 py-3 rounded-4 fs-5" onclick="liff.closeWindow()">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
    </div>

    <div id="mainApp" class="d-none">
        <div class="app-header">
            <h2 class="mb-1 fw-bold">‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</h2>
            <p class="mb-0 fs-5">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢: <span id="patName" class="fw-bold text-warning"></span></p>
        </div>

        <div class="container mt-4 mb-5 pb-4">
            
            <div class="card">
                <div class="card-header text-primary border-primary">üíä ‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≤‡∏ô‡∏ó‡∏≤‡∏ô‡πÉ‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
                <div class="card-body" id="drugListContainer"></div>
            </div>

            <div class="card">
                <div class="card-header text-warning border-warning">üçΩÔ∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡∏∑‡πâ‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢)</div>
                <div class="card-body">
                    <p class="text-muted small mb-3">‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≤‡∏ô‡∏ó‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥ (‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ó‡∏≤‡∏ô‡∏°‡∏∑‡πâ‡∏≠‡πÉ‡∏î ‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ)</p>
                    <div class="mb-3"><label class="form-label">‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤</label><input type="time" class="form-control" id="mBreak"></div>
                    <div class="mb-3"><label class="form-label">‡∏°‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô</label><input type="time" class="form-control" id="mLunch"></div>
                    <div class="mb-3"><label class="form-label">‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô</label><input type="time" class="form-control" id="mDinner"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header text-danger border-danger">üö® ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÉ‡∏ô 7 ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤)</div>
                <div class="card-body">
                    <h6 class="fw-bold text-secondary">1. ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏´‡∏°‡∏î‡∏§‡∏ó‡∏ò‡∏¥‡πå (OFF-Time)</h6>
                    <div id="offTimeContainer">
                        <div class="row g-2 mb-2 off-row align-items-end">
                            <div class="col-5"><label class="form-label small mb-1">‡πÄ‡∏£‡∏¥‡πà‡∏°</label><input type="time" class="form-control off-start"></div>
                            <div class="col-5"><label class="form-label small mb-1">‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô</label><input type="time" class="form-control off-end"></div>
                            <div class="col-2"><button class="btn btn-outline-danger w-100 p-2" onclick="this.parentElement.parentElement.remove()" style="border-radius:10px;">‡∏•‡∏ö</button></div>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-primary mb-4 mt-1 fw-bold px-3 py-2" style="border-radius:10px;" onclick="addTimeRow('offTimeContainer', 'off')">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ OFF-Time</button>

                    <h6 class="fw-bold text-secondary mt-3">2. ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏¢‡∏∏‡∏Å‡∏¢‡∏¥‡∏Å (Dyskinesia)</h6>
                    <div id="dysTimeContainer">
                        <div class="row g-2 mb-2 dys-row align-items-end">
                            <div class="col-5"><label class="form-label small mb-1">‡πÄ‡∏£‡∏¥‡πà‡∏°</label><input type="time" class="form-control dys-start"></div>
                            <div class="col-5"><label class="form-label small mb-1">‡∏´‡∏≤‡∏¢‡πÑ‡∏õ</label><input type="time" class="form-control dys-end"></div>
                            <div class="col-2"><button class="btn btn-outline-danger w-100 p-2" onclick="this.parentElement.parentElement.remove()" style="border-radius:10px;">‡∏•‡∏ö</button></div>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-primary mb-2 mt-1 fw-bold px-3 py-2" style="border-radius:10px;" onclick="addTimeRow('dysTimeContainer', 'dys')">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏¢‡∏∏‡∏Å‡∏¢‡∏¥‡∏Å</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header text-info border-info">üìã ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏û‡∏ö (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏Ç‡πâ‡∏≠)</div>
                <div class="card-body">
                    <div class="form-check checkbox-lg mb-3"><input class="form-check-input symp-check" type="checkbox" value="‡∏ï‡∏∑‡πà‡∏ô‡πÄ‡∏ä‡πâ‡∏≤‡∏°‡∏≤‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πá‡∏á‡πÄ‡∏Å‡∏£‡πá‡∏á (Morning Akinesia)" id="s1"><label class="form-check-label" for="s1">‡∏ï‡∏∑‡πà‡∏ô‡πÄ‡∏ä‡πâ‡∏≤‡∏°‡∏≤‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πá‡∏á‡πÄ‡∏Å‡∏£‡πá‡∏á ‡∏Ç‡∏¢‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏•‡πç‡∏≤‡∏ö‡∏≤‡∏Å (‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤‡∏°‡∏∑‡πâ‡∏≠‡πÅ‡∏£‡∏Å)</label></div>
                    <div class="form-check checkbox-lg mb-3"><input class="form-check-input symp-check" type="checkbox" value="‡∏¢‡∏≤‡∏≠‡∏≠‡∏Å‡∏§‡∏ó‡∏ò‡∏¥‡πå‡∏ä‡πâ‡∏≤‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ (Delayed ON)" id="s2"><label class="form-check-label" for="s2">‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤ ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏ô‡∏≤‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥‡∏¢‡∏≤‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏≠‡∏≠‡∏Å‡∏§‡∏ó‡∏ò‡∏¥‡πå</label></div>
                    <div class="form-check checkbox-lg mb-3"><input class="form-check-input symp-check" type="checkbox" value="‡∏´‡∏ô‡πâ‡∏≤‡∏°‡∏∑‡∏î/‡∏ß‡∏π‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡∏∏‡∏Å‡∏¢‡∏∑‡∏ô" id="s3"><label class="form-check-label text-danger" for="s3">‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πâ‡∏≤‡∏°‡∏∑‡∏î ‡∏ß‡∏π‡∏ö ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡πà‡∏≤‡∏•‡∏∏‡∏Å‡∏¢‡∏∑‡∏ô</label></div>
                    <div class="form-check checkbox-lg mb-3"><input class="form-check-input symp-check" type="checkbox" value="‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏´‡∏Å‡∏•‡πâ‡∏°‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå" id="s4"><label class="form-check-label text-danger fw-bold" for="s4">‡∏´‡∏Å‡∏•‡πâ‡∏° ‡∏ó‡∏£‡∏á‡∏ï‡∏±‡∏ß‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà (‡πÉ‡∏ô‡∏£‡∏≠‡∏ö 7 ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</label></div>
                    <div class="form-check checkbox-lg mb-3"><input class="form-check-input symp-check" type="checkbox" value="‡πÄ‡∏´‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏≠‡∏ô/‡∏™‡∏±‡∏ö‡∏™‡∏ô" id="s5"><label class="form-check-label" for="s5">‡πÄ‡∏´‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏™‡∏±‡∏ö‡∏™‡∏ô</label></div>
                    <div class="form-check checkbox-lg mb-3"><input class="form-check-input symp-check" type="checkbox" value="‡∏ô‡∏≠‡∏ô‡∏•‡∏∞‡πÄ‡∏°‡∏≠ ‡∏£‡πâ‡∏≠‡∏á‡∏ï‡∏∞‡πÇ‡∏Å‡∏ô" id="s6"><label class="form-check-label" for="s6">‡∏ô‡∏≠‡∏ô‡∏•‡∏∞‡πÄ‡∏°‡∏≠ ‡∏ù‡∏±‡∏ô‡∏£‡πâ‡∏≤‡∏¢ ‡∏£‡πâ‡∏≠‡∏á‡∏ï‡∏∞‡πÇ‡∏Å‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ï‡∏∞‡∏ï‡πà‡∏≠‡∏¢‡∏Ç‡∏ì‡∏∞‡∏´‡∏•‡∏±‡∏ö</label></div>
                    <div class="form-check checkbox-lg"><input class="form-check-input symp-check" type="checkbox" value="‡∏ó‡πâ‡∏≠‡∏á‡∏ú‡∏π‡∏Å‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á" id="s7"><label class="form-check-label" for="s7">‡∏ó‡πâ‡∏≠‡∏á‡∏ú‡∏π‡∏Å‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á</label></div>
                </div>
            </div>

            <button class="btn btn-primary w-100 py-3 mt-2 shadow-sm" onclick="confirmSubmission()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÅ‡∏û‡∏ó‡∏¢‡πå</button>
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // üî¥üî¥üî¥ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LIFF ID ‡πÅ‡∏•‡∏∞ API URL ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ üî¥üî¥üî¥
        const MY_LIFF_ID = "2009188241-wYw5i6WS"; 
        const API_URL = "https://script.google.com/macros/s/AKfycbzJ_FI7UePuEJ9-QG7w64pTG3vWhsitGFQ1NcrLgvDb2a0oQzhpmN4rTo8DbJ783Kc/exec"; 
        
        let drugDatabase = [];
        let userUid = "";

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const res = await fetch('./drugs.json');
                drugDatabase = await res.json();
            } catch(e) {}
            initializeLiff();
        });

        async function initializeLiff() {
            try {
                await liff.init({ liffId: MY_LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                userUid = profile.userId;
                fetchPatientData(userUid);
            } catch (err) {
                document.getElementById('loading').innerHTML = `<h4 class="text-danger">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h4><p>${err.message}</p>`;
            }
        }

        async function fetchPatientData(uid) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getLiffData', lineUid: uid })
                });
                const data = await response.json();

                if (data.status === 'success') {
                    if (data.isEligible === false) {
                        document.getElementById('nextDate').innerText = data.nextAvailableDate;
                        document.getElementById('loading').classList.add('d-none');
                        document.getElementById('lockedScreen').classList.remove('d-none');
                    } else {
                        document.getElementById('patName').innerText = data.patientName;
                        renderDrugList(data.activeDrugs);
                        document.getElementById('loading').classList.add('d-none');
                        document.getElementById('mainApp').classList.remove('d-none');
                    }
                } else {
                    document.getElementById('loading').classList.add('d-none');
                    document.getElementById('bindScreen').classList.remove('d-none');
                }
            } catch (e) {
                document.getElementById('loading').innerHTML = `<h4 class="text-danger">‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á</h4>`;
            }
        }

        async function bindAccount() {
            let hn = document.getElementById('bindHN').value.trim();
            let phone = document.getElementById('bindPhone').value.trim();
            if(!hn || !phone) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'warning');

            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); }});

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'bindLineAccount', hn: hn, phone: phone, lineUid: userUid })
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏ú‡∏π‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success').then(() => {
                        document.getElementById('bindScreen').classList.add('d-none');
                        document.getElementById('loading').classList.remove('d-none');
                        fetchPatientData(userUid);
                    });
                } else {
                    Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', data.message, 'error');
                }
            } catch (e) {
                Swal.fire('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
            }
        }

        function renderDrugList(drugIds) {
            const container = document.getElementById('drugListContainer');
            if(drugIds.length === 0) {
                container.innerHTML = "<p class='text-muted text-center'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>";
                return;
            }
            let html = "";
            drugIds.forEach(id => {
                let drugInfo = drugDatabase.find(d => d.id === id);
                if(drugInfo) {
                    let pillImg = drugInfo.pill_image || "https://cdn-icons-png.flaticon.com/512/822/822092.png"; 
                    html += `<div class="drug-card"><img src="${pillImg}" class="drug-img"><div><h6 class="mb-1 fw-bold text-dark">${drugInfo.name}</h6><small class="text-muted">‡∏¢‡∏≤‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏û‡∏≤‡∏£‡πå‡∏Å‡∏¥‡∏ô‡∏™‡∏±‡∏ô</small></div></div>`;
                }
            });
            container.innerHTML = html;
        }

        // üåü ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏Å‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ)
        function addTimeRow(containerId, type) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `row g-2 mb-2 ${type}-row align-items-end`;
            div.innerHTML = `
                <div class="col-5"><input type="time" class="form-control ${type}-start"></div>
                <div class="col-5"><input type="time" class="form-control ${type}-end"></div>
                <div class="col-2"><button class="btn btn-outline-danger w-100 p-2" onclick="this.parentElement.parentElement.remove()" style="border-radius:10px;">‡∏•‡∏ö</button></div>
            `;
            container.appendChild(div);
        }

        function confirmSubmission() {
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?',
                html: '<span class="text-danger fw-bold">‚ö†Ô∏è ‡∏ó‡πà‡∏≤‡∏ô‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</span><br><br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#4CAF50',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                cancelButtonText: '‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'
            }).then((result) => {
                if (result.isConfirmed) submitData();
            });
        }

        async function submitData() {
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); }});
            
            // üåü ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡πÜ ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏Å‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ß‡πâ üåü
            let offTimes = [];
            document.querySelectorAll('.off-row').forEach(row => {
                let s = row.querySelector('.off-start').value;
                let e = row.querySelector('.off-end').value;
                if(s && e) offTimes.push({start: s, end: e});
            });

            let dysTimes = [];
            document.querySelectorAll('.dys-row').forEach(row => {
                let s = row.querySelector('.dys-start').value;
                let e = row.querySelector('.dys-end').value;
                if(s && e) dysTimes.push({start: s, end: e});
            });

            let otherSymptoms = Array.from(document.querySelectorAll('.symp-check:checked')).map(cb => cb.value);

            let payload = {
                action: 'submitLiffData',
                lineUid: userUid,
                mealBreak: document.getElementById('mBreak').value || "-",
                mealLunch: document.getElementById('mLunch').value || "-",
                mealDinner: document.getElementById('mDinner').value || "-",
                offTimes: offTimes,   // ‡∏™‡πà‡∏á Array ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà Code.gs
                dysTimes: dysTimes,   // ‡∏™‡πà‡∏á Array ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà Code.gs
                otherSymptoms: otherSymptoms
            };

            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                const data = await response.json();
                
                if (data.status === 'success') {
                    Swal.fire({ icon: 'success', title: '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', text: '‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πà‡∏ß‡∏°‡∏°‡∏∑‡∏≠‡∏Ñ‡∏£‡∏±‡∏ö', confirmButtonText: '‡∏õ‡∏¥‡∏î', confirmButtonColor: '#4CAF50' }).then(() => { liff.closeWindow(); });
                } else { Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', data.message, 'error'); }
            } catch (e) { Swal.fire('‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error'); }
        }
    </script>
</body>
</html>
